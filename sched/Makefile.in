DEPTH   = ..
topsrcdir       = @top_srcdir@
srcdir          = @srcdir@
VPATH           = @srcdir@

INSTALL_DIR = /usr/local/boinc

CFLAGS = -g -Wall @DEFS@ \
    -I@top_srcdir@/db \
    -I@top_srcdir@/lib \
    -I@top_srcdir@/tools \
    -I/usr/local/mysql/include \
    -I@top_srcdir@/RSAEuro/source \
    -DMAJOR_VERSION=$(BOINC_MAJOR_VERSION) \
    -DMINOR_VERSION=$(BOINC_MINOR_VERSION)

CC = g++ $(CFLAGS)

CLIBS = @LIBS@

PROGS = cgi feeder show_shmem file_upload_handler validate_test make_work result_retry file_deleter assimilator

all: $(PROGS)

CGI_OBJS = \
    handle_request.o \
    main.o \
    sched_shmem.o \
    server_types.o \
    config.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/shmem.o \
    ../lib/parse.o

FEEDER_OBJS = \
    feeder.o \
    sched_shmem.o \
    config.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/parse.o \
    ../lib/shmem.o

SHOW_SHMEM_OBJS = \
    show_shmem.o \
    sched_shmem.o \
    config.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/parse.o \
    ../lib/shmem.o

FILE_UPLOAD_OBJS = \
    file_upload_handler.o \
    config.o \
    ../lib/crypt.o \
    ../lib/parse.o \
    ../lib/md5.o \
    ../lib/md5_file.o \
    ../RSAEuro/source/rsaeuro.a

VALIDATE_OBJS = \
    validate.o \
    validate_test.o \
    config.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/parse.o

FILE_DELETER_OBJS = \
    file_deleter.o \
    config.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/parse.o

ASSIMILATOR_OBJS = \
    assimilator.o \
    config.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/parse.o

MAKE_WORK_OBJS = \
    make_work.o \
    config.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../tools/backend_lib.o \
    ../tools/process_result_template.o \
    ../lib/parse.o \
    ../lib/md5_file.o \
    ../lib/md5.o \
    ../lib/crypt.o \
    ../RSAEuro/source/rsaeuro.a

RESULT_RETRY_OBJS = \
    result_retry.o \
    config.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/parse.o \
    ../lib/md5_file.o \
    ../lib/md5.o \
    ../lib/crypt.o \
    ../tools/backend_lib.o \
    ../tools/process_result_template.o \
    ../RSAEuro/source/rsaeuro.a

FCGI_OBJS = \
    handle_request.fcgi.o \
    main.fcgi.o \
    sched_shmem.fcgi.o \
    server_types.fcgi.o \
    ../db/db_mysql.fcgi.o \
    ../db/mysql_util.fcgi.o \
    ../lib/shmem.fcgi.o \
    ../lib/parse.fcgi.o \
    ../lib/crypt.fcgi.o \
    ../lib/md5.o \
    ../lib/md5_file.o \
    ../RSAEuro/source/rsaeuro.a \
    ../tools/process_result_template.fcgi.o
FCGI_LIBS = -lfcgi -lfcgi++
FCGI_FLAGS = -include /usr/local/include/fcgi_stdio.h -D_USING_FCGI_

MYSQL_DIR = /usr/local/mysql/lib
MYSQL_LIBS = \
-L$(MYSQL_DIR) -L/sw/lib/mysql -L/usr/local/lib/mysql \
-lmysqlclient -L/usr/local/lib -lz \
-lm $(NETLIBS) 

%.fcgi.o: %.C
	$(CC) $(FCGI_FLAGS) -c $*.C -o $*.fcgi.o

%.fcgi.o: %.c
	$(CC) $(FCGI_FLAGS) -c $*.c -o $*.fcgi.o

.C.o:
	$(CC) -c -o $*.o $<

.c.o:
	$(CC) -c -o $*.o $<

cgi: $(CGI_OBJS)
	$(CC) $(CGI_OBJS) $(MYSQL_LIBS) $(CLIBS) -o cgi

feeder: $(FEEDER_OBJS)
	$(CC) $(FEEDER_OBJS) $(MYSQL_LIBS) $(CLIBS) -o feeder

show_shmem: $(SHOW_SHMEM_OBJS)
	$(CC) $(SHOW_SHMEM_OBJS) $(MYSQL_LIBS) $(CLIBS) -o show_shmem

file_upload_handler: $(FILE_UPLOAD_OBJS)
	$(CC) $(FILE_UPLOAD_OBJS) $(CLIBS) -o file_upload_handler

validate_test: $(VALIDATE_OBJS)
	$(CC) $(VALIDATE_OBJS) $(MYSQL_LIBS) $(CLIBS) -o validate_test

make_work: $(MAKE_WORK_OBJS)
	$(CC) $(MAKE_WORK_OBJS) $(MYSQL_LIBS) $(CLIBS) -o make_work

result_retry: $(RESULT_RETRY_OBJS)
	$(CC) $(RESULT_RETRY_OBJS) $(MYSQL_LIBS) $(CLIBS) -o result_retry

file_deleter: $(FILE_DELETER_OBJS)
	$(CC) $(FILE_DELETER_OBJS) $(MYSQL_LIBS) $(CLIBS) -o file_deleter

assimilator: $(ASSIMILATOR_OBJS)
	$(CC) $(ASSIMILATOR_OBJS) $(MYSQL_LIBS) $(CLIBS) -o assimilator

fcgi: $(FCGI_OBJS)
	$(CC) $(FCGI_OBJS) $(MYSQL_LIBS) $(CLIBS) $(FCGI_LIBS) \
	    -o fcgi

dependencies: @srcdir@/*.C
	$(CC) -M @srcdir@/*.C > dependencies

include dependencies

clean:
	rm -f $(PROGS) *.o core dependencies config.cache

install: $(PROGS)
	-mkdir -p $(INSTALL_DIR)/cgi
	-mkdir -p $(INSTALL_DIR)/sched
	cp fcgi $(INSTALL_DIR)/cgi/fcgi
	cp cgi $(INSTALL_DIR)/cgi/cgi
	cp feeder $(INSTALL_DIR)/sched/feeder
	cp show_shmem $(INSTALL_DIR)/sched/show_shmem
	cp file_upload_handler $(INSTALL_DIR)/cgi/file_upload_handler

uninstall: 
	$(RM) -r $(INSTALL_DIR)/cgi;
	$(RM) -r $(INSTALL_DIR)/sched;
