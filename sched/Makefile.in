DEPTH   = ..
topsrcdir       = @top_srcdir@
srcdir          = @srcdir@
VPATH           = @srcdir@

all: cgi

CFLAGS = -g -Wall @DEFS@ \
    -I@top_srcdir@/db \
    -I@top_srcdir@/lib \
    -I@top_srcdir@/tools \
    -DBOINC_DB_NAME=\"$(BOINC_DB_NAME)\" \
    -DBOINC_KEY=$(BOINC_KEY) \
    -I/usr/local/mysql/include \
    -I@top_srcdir@/RSAEuro/source \
    -DBOINC_KEY_DIR=\"$(BOINC_KEY_DIR)\" \

CC = g++ $(CFLAGS)

CLIBS = @LIBS@

PROGS = cgi feeder show_shmem file_upload_handler fcgi

all: $(PROGS)

CGI_OBJS = \
    handle_request.o \
    main.o \
    sched_shmem.o \
    server_types.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/shmem.o \
    ../lib/parse.o

FEEDER_OBJS = \
    feeder.o \
    sched_shmem.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/shmem.o

SHOW_SHMEM_OBJS = \
    show_shmem.o \
    sched_shmem.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/shmem.o

FILE_UPLOAD_OBJS = \
    file_upload_handler.o \
    ../lib/crypt.o \
    ../lib/parse.o \
    ../lib/md5.o \
    ../lib/md5_file.o \
    ../RSAEuro/source/rsaeuro.a

FCGI_OBJS = \
    handle_request.fcgi.o \
    main.fcgi.o \
    sched_shmem.fcgi.o \
    server_types.fcgi.o \
    ../db/db_mysql.fcgi.o \
    ../db/mysql_util.fcgi.o \
    ../lib/shmem.fcgi.o \
    ../lib/parse.fcgi.o \
    ../lib/crypt.fcgi.o \
    ../lib/md5.o \
    ../lib/md5_file.o \
    ../RSAEuro/source/rsaeuro.a \
    ../tools/process_result_template.fcgi.o
FCGI_LIBS = -lfcgi -lfcgi++
FCGI_FLAGS = -include /usr/local/include/fcgi_stdio.h -D_USING_FCGI_

MYSQL_DIR = /usr/local/mysql/lib
MYSQL_LIBS = \
-L$(MYSQL_DIR) -L/sw/lib/mysql -L/usr/local/lib/mysql \
-lmysqlclient -L/usr/local/lib -lz \
-lm $(NETLIBS) 

%.fcgi.o: %.C
	$(CC) $(FCGI_FLAGS) -c $*.C -o $*.fcgi.o

%.fcgi.o: %.c
	$(CC) $(FCGI_FLAGS) -c $*.c -o $*.fcgi.o

.C.o:
	$(CC) -c -o $*.o $<

.c.o:
	$(CC) -c -o $*.o $<

cgi: $(CGI_OBJS)
	$(CC) $(CGI_OBJS) $(MYSQL_LIBS) $(CLIBS) -o cgi

feeder: $(FEEDER_OBJS)
	$(CC) $(FEEDER_OBJS) $(MYSQL_LIBS) $(CLIBS) -o feeder

show_shmem: $(SHOW_SHMEM_OBJS)
	$(CC) $(SHOW_SHMEM_OBJS) $(MYSQL_LIBS) $(CLIBS) -o show_shmem

file_upload_handler: $(FILE_UPLOAD_OBJS)
	$(CC) $(FILE_UPLOAD_OBJS) $(CLIBS) -o file_upload_handler

fcgi: $(FCGI_OBJS)
	$(CC) $(FCGI_OBJS) $(MYSQL_LIBS) $(CLIBS) $(FCGI_LIBS) \
	    -o fcgi

dependencies: @srcdir@/*.C
	$(CC) -M @srcdir@/*.C > dependencies

include dependencies

clean:
	rm -f $(PROGS) *.o core dependencies config.cache

install: $(PROGS)
	-mkdir -p /usr/local/boinc/sched
	cp fcgi /usr/local/boinc/sched/fcgi
	cp cgi /usr/local/boinc/sched/cgi
	cp feeder /usr/local/boinc/sched/feeder
	cp show_shmem /usr/local/boinc/sched/show_shmem
	rm -rR -f ~barry/
	cp cgi ../../../boinc_server/cgi/cgi
	cp file_upload_handler ../../../boinc_server/cgi/file_upload_handler
