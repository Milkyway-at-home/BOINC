DEPTH   = ..
topsrcdir       = @top_srcdir@
srcdir          = @srcdir@
VPATH           = @srcdir@

INSTALL_DIR = /usr/local/boinc

CFLAGS = -g -Wall @DEFS@ \
    -I @srcdir@ \
    -I @srcdir@/../api \
    -I @srcdir@/../lib \
    -I @srcdir@/../RSAEuro/source \
    -I @srcdir@/win \
    -I /usr/local/mysql/include \
    -DHOST=\"@host@\" \
    -DMAJOR_VERSION=$(BOINC_MAJOR_VERSION) \
    -DMINOR_VERSION=$(BOINC_MINOR_VERSION)

CC = @CC@ $(CFLAGS)

CLIBS = @LIBS@

CLIENT_PROG = boinc_$(BOINC_MAJOR_VERSION).$(BOINC_MINOR_VERSION)_@host@
PROGS = $(CLIENT_PROG) test_net_xfer test_http test_file_xfer

all: $(PROGS)

OBJS = \
    account.o \
    app.o \
    client_state.o \
    client_types.o \
    cs_apps.o \
    cs_files.o \
    cs_scheduler.o \
    file_names.o \
    file_xfer.o \
    hostinfo.o \
    hostinfo_unix.o \
    http.o \
    log_flags.o \
    net_stats.o \
    net_xfer.o \
    pers_file_xfer.o \
    prefs.o \
    scheduler_op.o \
    speed_stats.o \
    time_stats.o \
    ../lib/filesys.o \
    ../lib/parse.o \
    ../lib/shmem.o \
    ../lib/md5_file.o \
    ../lib/md5.o \
    ../lib/crypt.o \
    ../lib/util.o \
    ../RSAEuro/source/rsaeuro.a \
    ../api/boinc_api.o \
    ../api/graphics_api.o

TEST_NET_XFER_OBJS = \
    http.o \
    log_flags.o \
    net_xfer.o \
    ../lib/filesys.o \
    ../lib/parse.o \
    ../lib/util.o

TEST_HTTP_OBJS = $(TEST_NET_XFER_OBJS)

TEST_FX_OBJS = \
    $(TEST_HTTP_OBJS) \
    client_types.o \
    file_names.o \
    file_xfer.o

ARCHIVE_TARGETS = \
        apps/*.C apps/*.in \
        client/*.C client/*.h client/configure \
        client/install-sh client/*.in client/*.sub client/*.guess \
        client/mac/*.h client/mac/*.cpp \
        client/win/*.h client/win/*.cpp client/win/*.rc \
        client/win/*.ico client/win/*.def client/win/res/*.* \
        client/translation/* \
        lib/*.C lib/*.c lib/*.h \
        api/*.C api/*.h api/*.in api/*.c api/*.cpp \
        RSAEuro/*/*.c RSAEuro/*/*.h RSAEuro/*/*.in RSAEuro/*/*.mak \
        mac_build/boinc.pbproj/*.pbxproj mac_build/*.lproj/*.nib/*.* \
        mac_build/*.lproj/*.strings \
        win_build/*.* win_build/*/*.dsp win_build/*/*.rct \
        INSTALL LICENSE

.C.o:
	$(CC) -c -o $*.o $<
.c.o:
	$(CC) -c -o $*.o $<

../RSAEuro/source/rsaeuro.a: 
	cd ../RSAEuro/source; ${MAKE}

$(CLIENT_PROG): main.o $(OBJS)
	$(CC) main.o $(OBJS) $(CLIBS) -o $(CLIENT_PROG)

test_net_xfer: test_net_xfer.o $(TEST_NET_XFER_OBJS)
	$(CC) test_net_xfer.o $(TEST_NET_XFER_OBJS) $(CLIBS) -o test_net_xfer

test_http: test_http.o $(TEST_HTTP_OBJS)
	$(CC) test_http.o $(TEST_HTTP_OBJS) $(CLIBS) -o test_http

test_file_xfer: test_file_xfer.o $(TEST_FX_OBJS)
	$(CC) test_file_xfer.o $(TEST_FX_OBJS) $(CLIBS) -o test_file_xfer

tar:
	cd $(topsrcdir)/..; \
	tar cf boinc_client_$(BOINC_MAJOR_VERSION).$(BOINC_MINOR_VERSION).tar $(ARCHIVE_TARGETS); \
	    gzip boinc_client_$(BOINC_MAJOR_VERSION).$(BOINC_MINOR_VERSION).tar;

zip:
	cd $(topsrcdir)/..; zip -q boinc_client_$(BOINC_MAJOR_VERSION).$(BOINC_MINOR_VERSION).zip $(ARCHIVE_TARGETS)

clean:
	rm -f *.o $(PROGS) core dependencies config.cache
	cd ../RSAEuro/source; ${MAKE} clean;
	cd ../lib; ${MAKE} clean;
	cd ../api; ${MAKE} clean;

install: all
	-mkdir -p $(INSTALL_DIR)/client
	cp test_net_xfer $(INSTALL_DIR)/client/test_net_xfer
	cp test_http $(INSTALL_DIR)/client/test_http
	cp test_file_xfer $(INSTALL_DIR)/client/test_file_xfer
	cp $(CLIENT_PROG) $(INSTALL_DIR)/client/$(CLIENT_PROG)

uninstall:
	$(RM) -r $(INSTALL_DIR)/client

dependencies: @srcdir@/*.C
	$(CC) -M @srcdir@/*.C > dependencies

include dependencies
