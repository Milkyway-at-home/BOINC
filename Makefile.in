SHELL = /bin/sh

DEPTH	= .
topsrcdir	= @top_srcdir@
srcdir	= @srcdir@
VPATH	= @srcdir@

INSTALL_DIR = /usr/local/boinc

ENV_MSG_1 = "The environment variable "
ENV_MSG_2 = " does not seem to be set. "
ENV_MSG_3 = "Please be sure to set all environment variables before compiling. "
ifndef BOINC_PROJECTS_DIR
BOINC_WARN_ENV = 1
BOINC_PROJECTS_DIR_MSG = $(ENV_MSG_1)"BOINC_PROJECTS_DIR"$(ENV_MSG_2)
endif
ifndef BOINC_HOSTS_DIR
BOINC_WARN_ENV = 1
BOINC_HOSTS_DIR_MSG = $(ENV_MSG_1)"BOINC_HOSTS_DIR"$(ENV_MSG_2)
endif
ifndef BOINC_USER_NAME
BOINC_WARN_ENV = 1
BOINC_USER_NAME_MSG = $(ENV_MSG_1)"BOINC_USER_NAME"$(ENV_MSG_2)
endif
ifndef BOINC_SRC_DIR
BOINC_WARN_ENV = 1
BOINC_SRC_DIR_MSG = $(ENV_MSG_1)"BOINC_SRC_DIR"$(ENV_MSG_2)
endif
ifndef BOINC_CGI_DIR
BOINC_WARN_ENV = 1
BOINC_CGI_DIR_MSG = $(ENV_MSG_1)"BOINC_CGI_DIR"$(ENV_MSG_2)
endif
ifndef BOINC_CGI_URL
BOINC_WARN_ENV = 1
BOINC_CGI_URL_MSG = $(ENV_MSG_1)"BOINC_CGI_URL"$(ENV_MSG_2)
endif
ifndef BOINC_HTML_DIR
BOINC_WARN_ENV = 1
BOINC_HTML_DIR_MSG = $(ENV_MSG_1)"BOINC_HTML_DIR"$(ENV_MSG_2)
endif
ifndef BOINC_HTML_URL
BOINC_WARN_ENV = 1
BOINC_HTML_URL_MSG = $(ENV_MSG_1)"BOINC_HTML_URL"$(ENV_MSG_2)
endif
ifndef BOINC_KEY_DIR
BOINC_WARN_ENV = 1
BOINC_KEY_DIR_MSG = $(ENV_MSG_1)"BOINC_KEY_DIR"$(ENV_MSG_2)
endif
ifndef BOINC_PLATFORM
BOINC_WARN_ENV = 1
BOINC_PLATFORM_KEY_MSG = $(ENV_MSG_1)"BOINC_PLATFORM_KEY"$(ENV_MSG_2)
endif
ifdef BOINC_WARN_ENV
ENV_MESSAGES = "****************************************" \
    $(BOINC_HOSTS_DIR_MSG) \
    $(BOINC_PROJECTS_DIR_MSG) \
    $(BOINC_USER_NAME_MSG) \
    $(BOINC_SRC_DIR_MSG) \
    $(BOINC_CGI_DIR_MSG) \
    $(BOINC_CGI_URL_MSG) \
    $(BOINC_HTML_DIR_MSG) \
    $(BOINC_HTML_URL_MSG) \
    $(BOINC_KEY_DIR_MSG) \
    $(BOINC_PLATFORM_MSG) \
    $(ENV_MSG_3) \
    "****************************************"
EXIT_IF_NEEDED = @exit 1;
endif

#
#	The ../$(srcdir)/client/configure
#	only works when the original configure is relative path
#	it doesn't work when it is an absolute path
#	This needs to be fixed
#
all: messages
	cd RSAEuro/source; ${MAKE}; cd ../..; \
	cd db; ${MAKE}; cd ..; \
	cd lib; ${MAKE}; cd ..; \
	cd api; ${MAKE}; cd ..; \
	cd apps; ${MAKE}; cd ..; \
	cd client; ../$(srcdir)/client/configure; ${MAKE}; cd ..; \
	cd sched; ${MAKE}; cd ..; \
	cd tools; ${MAKE}; cd ..;

messages:
	@echo $(ENV_MESSAGES)
	$(EXIT_IF_NEEDED)

clean:
	rm -f boinc.tar.gz config.cache; \
	cd RSAEuro/source/; ${MAKE} clean; cd ../../; \
	cd db; ${MAKE} clean; cd ..; \
	cd lib; ${MAKE} clean; cd ..; \
	cd api; ${MAKE} clean; cd ..; \
	cd apps; ${MAKE} clean; cd ..; \
	cd client; ${MAKE} clean; cd ..; \
	cd sched; ${MAKE} clean; cd ..; \
	cd tools; ${MAKE} clean; cd ..;

install: all
	-mkdir -p $(INSTALL_DIR);
	cd sched; ${MAKE} install;
	cd lib; ${MAKE} install;
	cd api; ${MAKE} install;
	cd apps; ${MAKE} install;
	cd client; ${MAKE} install;
	cd tools; ${MAKE} install;
	$(CP) -r test /usr/local/boinc;

uninstall:
	cd sched; ${MAKE} uninstall;
	cd lib; ${MAKE} uninstall;
	cd api; ${MAKE} uninstall;
	cd apps; ${MAKE} uninstall;
	cd client; ${MAKE} uninstall;
	cd tools; ${MAKE} uninstall;
	$(RM) -r $(INSTALL_DIR)/tools;

ARCHIVE_TARGETS = \
        client/*.C client/*.cpp client/*.h client/configure \
        client/install-sh client/*.in client/*.sub client/*.guess \
        client/mac/*.h client/mac/*.cpp \
        client/win/*.h client/win/*.cpp \
        apps/*.C apps/*.h apps/*.in \
        db/*.sql db/*.h db/*.C db/*.in db/init_db \
        doc/*.* \
        html_ops/*.* \
        html_user/*.* \
        lib/*.C lib/*.c lib/*.h lib/*.in \
        sched/*.C sched/*.h sched/*.in \
        sched_fcgi/*.C sched_fcgi/*.h sched_fcgi/*.in \
        test/*.xml test/*.php test/*wu test/*result test/*output \
        test/*.html test/*input \
        tools/*.C tools/*.h tools/*.in \
        api/*.C api/*.h api/*.in \
        RSAEuro/*/*.c RSAEuro/*/*.h RSAEuro/*/*.in RSAEuro/*/*.mak \
        mac_build/*.*/*.* mac_build/*.*/*.*/*.* \
        win_build.zip INSTALL LICENSE configure install-sh \
        *.in *.sub *.guess *.m4

tar: 
	tar cf boinc.tar $(ARCHIVE_TARGETS) ; gzip boinc.tar

zip:
	zip boinc.zip $(ARCHIVE_TARGETS)

client_tar: clean
	cd client; ./configure; ${MAKE} tar;
