DEPTH   = ..
topsrcdir       = @top_srcdir@
srcdir          = @srcdir@
VPATH           = @srcdir@

all: cgi

CFLAGS = -g -Wall -include /usr/local/include/fcgi_stdio.h -d_USING_FCGI_ @DEFS@ -I@top_srcdir@/db -I@top_srcdir@/lib -I@top_srcdir@/tools
CC = g++ $(CFLAGS)

CLIBS = @LIBS@ -lfcgi -lfcgi++

PROGS = cgi feeder show_shmem

all: $(PROGS)

CGI_OBJS = \
    ../sched/handle_request.o \
    ../sched/main.o \
    ../sched/sched_shmem.o \
    ../sched/server_types.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/shmem.o \
    ../lib/parse.o \
    ../tools/process_result_template.o

FEEDER_OBJS = \
    ../sched/feeder.o \
    ../sched/sched_shmem.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/shmem.o

SHOW_SHMEM_OBJS = \
    ../sched/show_shmem.o \
    ../sched/sched_shmem.o \
    ../db/db_mysql.o \
    ../db/mysql_util.o \
    ../lib/shmem.o

MYSQL_DIR = /usr/local/mysql/lib
MYSQL_LIBS = \
-L$(MYSQL_DIR) -L/sw/lib/mysql -L/usr/local/lib/mysql \
-lmysqlclient -L/usr/local/lib -lz \
-lm $(NETLIBS) 

.C.o:
	rm -f ../lib/parse.o
	rm -f ../sched/feeder.o \
	      ../sched/main.o \
	      ../sched/server_types.o \
	      ../sched/sched_shmem.o \
	      ../sched/show_shmem.o
	$(CC) -c -o $*.o $<
.c.o:
	$(CC) -c -o $*.o $<

cgi: $(CGI_OBJS)
	$(CC) $(CGI_OBJS) $(MYSQL_LIBS) $(CLIBS) -o fcgi

feeder: $(FEEDER_OBJS)
	$(CC) $(FEEDER_OBJS) $(MYSQL_LIBS) $(CLIBS) -o feeder

show_shmem: $(SHOW_SHMEM_OBJS)
	$(CC) $(SHOW_SHMEM_OBJS) $(MYSQL_LIBS) $(CLIBS) -o show_shmem

dependencies: @srcdir@/*.C
	$(CC) -M @srcdir@/*.C > dependencies

include dependencies

clean:
	rm -f $(PROGS) *.o core dependencies config.cache
	rm -f ../sched/feeder.o \
	      ../sched/main.o \
	      ../sched/server_types.o \
	      ../sched/sched_shmem.o \
	      ../sched/show_shmem.o
	rm -f ../lib/parse.o
